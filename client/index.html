<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Thing</title>
    <link rel="stylesheet" href="https://gwar.ageofikon.com/static/custom.css"
          type="text/css">
    <link rel="stylesheet" href="https://gwar.ageofikon.com/static/masonry.css"
          type="text/css">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.6.3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://npmcdn.com/imagesloaded@4.1/imagesloaded.pkgd.min.js"></script>
    <script src="https://unpkg.com/masonry-layout@4.1/dist/masonry.pkgd.min.js"></script>
    <link rel="stylesheet" href="fancybox/jquery.fancybox.css?v=2.1.5"
          type="text/css" media="screen"/>
    <script type="text/javascript"
            src="fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
    <link rel="stylesheet"
          href="fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"
          type="text/css" media="screen"/>
    <script type="text/javascript"
            src="fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
    <script src="jquery.endless-scroll.js"></script>
    <script src="aws-config.js"></script>

    <script type="text/javascript">
        function addImageToPage(image) {
            var url = base_path + image['path'];
            var thumb_url = base_thumb_path + image['path'];

            var colors = base_path + image['colors'];

            var div = document.createElement('li');
            div.className = 'item';

            var a = document.createElement('a');
            a.className = 'fancybox-thumb';
            a.href = url;
            a.rel = 'fancybox-thumb';
            a.alt = "";

            var pic = document.createElement('picture');
            pic.className = 'px300';

            var src = document.createElement('source');
            src.setAttribute('media', "(max-width: 300px)");
            src.setAttribute('srcset', url);

            var img = document.createElement('img');
            img.className = 'px300';
            img.src = thumb_url;
            img.alt = 'hello';
            img.setAttribute('data-post', '1');
            img.setAttribute('data-user', '1');

            pic.appendChild(src);
            pic.appendChild(img);

            a.appendChild(pic);
            div.appendChild(a);
            $('#container').append(div);
            return div;
        }

        function tableScanCallback(error, data) {
            console.log("Table scan complete.");
            if (error) {
                console.log(error);
            } else {
                console.log(data);
                lastEvaluatedKey = data["LastEvaluatedKey"];
                var images = data["Items"];
                var elements = [];
                for (var i = 0, len = images.length; i < len; i++) {
                    elements.push(addImageToPage(images[i]));
                }
                var $container = $('#container');
                $container.imagesLoaded(function () {
                    $container.masonry('appended', elements, true);
                });
            }
        }

        function layoutCompleteCallback(event, items) {
            console.log("Layout complete, enabling fancybox.");
            $(".fancybox-thumb").fancybox({
                padding: 0,
                margin: [20, 60, 20, 60],
                prevEffect: 'none',
                nextEffect: 'none',
                helpers: {
                    title: {
                        type: 'over'
                    },
                    thumbs: {
                        height: 50
                    }
                },
                beforeShow: function () {
                    var alt = this.element.find('img').attr('alt');
                    var post = this.element.find('img').attr('data-post');
                    var user = this.element.find('img').attr('data-user');
                    this.inner.find('img').attr('alt', alt);
                    if (user && post)
                        this.title = "<a style='color: white;' target='_blank' href='../user/" + user + "'>" + user + "</a> - <a style='color: white;' target='_blank' href='/gwar/viewpost/" + post + "'>" + alt + "</a>";
                },

                afterShow: function () {
                    $(".fancybox-title").wrapInner('<div />').show();
                    $(".fancybox-wrap").hover(function () {
                        $(".fancybox-title").show();
                    }, function () {
                        $(".fancybox-title").hide();
                    });
                }
            });
        }

        function getMoreImages(page) {
            console.log("Getting more images, page: " + page);
            var params = {
                TableName: "images",
                Limit: pageItemCount,
                ExclusiveStartKey: lastEvaluatedKey
            };
            docClient.scan(params, tableScanCallback);
        }
    </script>
    <script>
        var docClient = new AWS.DynamoDB.DocumentClient();
        var pageItemCount = 50;
        var lastEvaluatedKey = null;

        getMoreImages(0);
        getMoreImages(0);

        $(document).ready(function () {
            console.log("Document ready, running initial masonry init.");
            var $container = $('#container');
            $container.masonry({
                itemSelector: '.item',
                columnWidth: 1,
                containerWidth: 300,
                isFitWidth: true
            });
            $container.on('layoutComplete', layoutCompleteCallback);
            $(window).endlessScroll({
                fireOnce: false,
                fireDelay: false,
                loader: '<div class="loading"><div>',
                inflowPixels: 2000,
                ceaseFireOnEmpty: false,
                callback: getMoreImages
            });
        });
    </script>
</head>
<body>
<ul id="container" class="masonry"></ul>
</body>
</html>