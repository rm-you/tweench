<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Thing</title>
    <link rel="stylesheet" href="web/client.css" type="text/css">
    <link rel="stylesheet" href="web/fancybox/jquery.fancybox.css?v=2.1.5"
          type="text/css" media="screen"/>
    <link rel="stylesheet"
          href="web/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"
          type="text/css" media="screen"/>
    <script src="web/jquery-2.1.1.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.6.3.min.js"></script>
    <script src="web/imagesloaded.pkgd.min.js"></script>
    <script src="web/masonry.pkgd.min.js"></script>
    <script src="web/jquery.endless-scroll.js"></script>
    <script type="text/javascript"
    src="web/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
    <script type="text/javascript"
    src="web/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
    <script src="web/aws-config.js"></script>

    <script type="text/javascript">
        function addImageToPage(image, post) {
            var url = base_path + image['path'];
            var thumb_url = base_thumb_path + image['path'];

            var colors = base_path + image['colors'];

            var li = document.createElement('li');
            li.classList.add('item');
            li.classList.add('hidden');

            var a = document.createElement('a');
            a.className = 'fancybox-thumb';
            a.href = url;
            a.rel = 'fancybox-thumb';
            a.alt = "";

            var pic = document.createElement('picture');
            pic.className = 'px300';

            var src = document.createElement('source');
            src.setAttribute('media', "(max-width: 300px)");
            src.setAttribute('srcset', url);

            var img = document.createElement('img');
            img.className = 'px300';
            img.src = thumb_url;
            img.alt = post.title;
            img.setAttribute('data-post', post.permalink);
            img.setAttribute('data-user', post.user);

            pic.appendChild(src);
            pic.appendChild(img);

            a.appendChild(pic);
            li.appendChild(a);
            $('#container').append(li);
            return li;
        }

        function tableScanCallback(error, data) {
            console.log("Table scan complete.");
            if (error) {
                console.log(error);
            } else {
                console.log(data);
                lastEvaluatedKey = data["LastEvaluatedKey"];
                var posts = data["Items"];
                var elements = [];
                for (var i = 0, posts_len = posts.length; i < posts_len; i++) {
                    var post = posts[i];
                    var images = post.images;
                    if (typeof(images) === 'undefined') {
                        continue;
                    }
                    for (var j = 0, images_len = images.length; j < images_len; j++) {
                        if (typeof(images[j]['path']) !== 'undefined') {
                            elements.push(addImageToPage(images[j], post));
                        }
                    }
                    if (elements.length >= maxImageCount) {
                        lastEvaluatedKey.id = post.id;
                        break;
                    }
                }
                var $container = $('#container');
                $container.imagesLoaded(function () {
                    $container.masonry('appended', elements, true);
                });
            }
        }

        function layoutCompleteCallback(event, items) {
            console.log("Layout complete, enabling fancybox.");
            downloadLock = false;
            $(".hidden").removeClass("hidden");
            $(".fancybox-thumb").fancybox({
                padding: 0,
                margin: [20, 60, 20, 60],
                prevEffect: 'none',
                nextEffect: 'none',
                helpers: {
                    title: {
                        type: 'over'
                    },
                    thumbs: {
                        height: 50
                    }
                },
                beforeShow: function () {
                    var alt = this.element.find('img').attr('alt');
                    var post = this.element.find('img').attr('data-post');
                    var user = this.element.find('img').attr('data-user');
                    this.inner.find('img').attr('alt', alt);
                    if (user && post)
                        this.title = "<a style='color: white;' target='_blank' href='https://www.reddit.com/u/" + user + "/submitted/'>" + user + "</a> - <a style='color: white;' target='_blank' href=" + post + "'>" + alt + "</a>";
                },

                afterShow: function () {
                    $(".fancybox-title").wrapInner('<div />').show();
                    $(".fancybox-wrap").hover(function () {
                        $(".fancybox-title").show();
                    }, function () {
                        $(".fancybox-title").hide();
                    });
                }
            });
            if ($('#container')[0].children.length < minTotalImageCount) {
                getMoreImages(-1);
            }
        }

        function getMoreImages(page, sequence, scrollDirection) {
            if (downloadLock) {
                console.log("Already downloading images, aborting.")
                return;
            }
            if (lastEvaluatedKey == null) {
                console.log("Ran out of images. We're done!");
                return;
            } else if (lastEvaluatedKey == -1) {
                // Set our initial key to null AFTER the null check
                lastEvaluatedKey = null;
            }

            downloadLock = true;
            if (sequence == null || sequence > 0) {
                console.log("Getting more images, page/direction: "
                        + page + "/" + scrollDirection);
                var params = {
                    TableName: "posts",
                    Limit: postLoadCount,
                    FilterExpression: "#sr = :name",
                    ExpressionAttributeNames: {
                        "#sr": "subreddit"
                    },
                    ExpressionAttributeValues: {
                        ":name": subredditToShow
                    },
                    ExclusiveStartKey: lastEvaluatedKey
                };
                docClient.scan(params, tableScanCallback);
            } else {
                console.log("Sequence was negative, ignoring.");
            }
        }

        function ceaseFireCallback() {
            return lastEvaluatedKey == null;
        }
    </script>
    <script>
        var downloadLock = false;
        var docClient = new AWS.DynamoDB.DocumentClient();
        var lastEvaluatedKey = -1;
        var maxImageCount = 50;
        var minTotalImageCount = 50;
        var postLoadCount = 50;
        var subredditToShow = "FoodPorn";

        getMoreImages(-1);

        $(document).ready(function () {
            console.log("Document ready, running initial masonry init.");
            var $container = $('#container');
            $container.masonry({
                itemSelector: '.item',
                columnWidth: 1,
                containerWidth: 300,
                isFitWidth: true
            });
            $container.on('layoutComplete', layoutCompleteCallback);
            $(window).endlessScroll({
                fireOnce: false,
                fireDelay: false,
                loader: '<div class="loading"><div>',
                inflowPixels: 2000,
                ceaseFireOnEmpty: false,
                callback: getMoreImages,
                ceaseFire: ceaseFireCallback
            });
        });
    </script>
</head>
<body>
<ul id="container" class="masonry"></ul>
</body>
</html>
